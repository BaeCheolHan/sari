# 03 Gate & Workflow

진행 의도 통제, 개발 흐름, 증거 규칙.
정본: `00-core.md`

---

## 행동 모드

| 토글 | 동작 |
|------|------|
| `@path` | 파일 찾기/네비게이션 |
| `스킬 OFF/ON` | 스킬 기능 kill-switch |

---

## 진행 의도 게이트 (v2.3.3 명확화)

### 기본 모드: Plan-only
**모든 대화는 기본적으로 Plan-only 모드로 시작**. 소스코드/환경설정 Change/Run은 명시적 승인 필요.

### 승인 단계 (3단계 게이트)

| 단계 | 조건 | 상태 |
|------|------|------|
| 1단계 | 변경 의사 확인 | 변경 가능 모드 진입 |
| 2단계 | repo/service 지정 | 타겟 확정 |
| 3단계 | 스케일 고지 + 사용자 확인 | **최종 승인** |

**중요**: 3단계 모두 통과해야 최종 승인.

### 자연어 신호 (참고용, 승인 아님)
- **진행 힌트**: 진행/적용/반영/구현/수정/고쳐/리팩토링/해결/만들어/추가해
  → 변경 승인 요청 응답 생성
- **Plan-only 강제**: 계획만/설계만/리뷰만/코드 변경하지 마/분석만
  → Change 완전 금지

### 위험 행동 (추가 게이트)
변경 승인 상태에서도 아래는 **1회 재확인 필수**:
- 파괴/비가역: 삭제/DDL/마이그레이션/데이터 덮어쓰기
- 외부 영향: 배포/인프라/네트워크/시크릿 노출
- 대규모: S2+ 예상(11+ files) 또는 3000 LOC 근접

### 오작동 방지 예시
```
User: "로그인 코드 수정해줘"
AI: [1단계 미통과] 수정 계획을 제안합니다. 진행 의사를 확인할게요.

User: "auth-service"
AI: [2단계 통과] 타겟: auth-service. 예상 S1 규모(4 files, ~200 LOC).
    진행할까요? ("approve execute" 또는 "run confirmed"로 승인해주세요)

User: "approve execute"
AI: [3단계 통과 - 최종 승인] 변경을 시작합니다.
```

---

## Phase Prompt (S1+ 권장)

S1 이상 작업 시 각 단계 완료 후 **다음 단계를 자연스럽게 제안**하여 품질 향상.

### 흐름
```
분석 → 설계 → 설계리뷰 → 코딩 → 코드리뷰 → 테스트 → 완료
```

### Prompt 예시
| 단계 완료 | 제안 |
|-----------|------|
| 분석 | "설계를 진행할까요?" |
| 설계 | "설계 리뷰가 필요하신가요? (리뷰/스킵)" |
| 코딩 | "코드 리뷰를 진행할까요?" |
| 테스트 | "완료 처리할까요?" |

### 규칙
- **강제 아님**: 사용자가 "스킵" 시 다음 단계로 이동
- **로그**: 스킵 시 "리뷰가 스킵되었습니다" 1줄 기록
- **S0 예외**: S0은 분석 → 코딩 → 완료 (간소화)

---

## 증거 규칙

| 작업 | 필요 증거 |
|------|-----------|
| Change | 경로 + diff (1~3 hunk) |
| Run | 명령 + 출력 (≤10줄) |

**완료/해결/확인은 증거 없이 선언 금지**. 애매하면 `확인 불가` 라벨링.

---

## Run 정책 (SAFE)

**허용**: git status/diff/show, rg/grep, mvn test, ./gradlew test, npm test, pytest, deckard 관련

**금지**: rm, sudo, kubectl, helm, terraform, DB 접속/DDL/DML, curl/wget (deckard 예외)

SAFE 외 명령은 **1회 재확인** 필수.

---

## Design Review 트리거

아래 중 하나면 Change 전 Design Review 선행:
- **Preflight**: deckard로 관련 lessons/API/ERD/glossary 조회
- 동작 변경 (비즈니스 로직/정책)
- 계약 변경 (API/DTO/스키마/에러코드)
- 성능/동시성/트랜잭션 변경
- 범위 S1+