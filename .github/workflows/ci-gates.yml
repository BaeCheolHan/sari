name: CI Gates

on: pull_request
    push:
        branches: [main]

jobs:
  critical-gates:
    name: Critical Runtime Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
          
      - name: Install dependencies (Forced)
        run: |
          python -m pip install --upgrade pip
          pip install tree-sitter==0.21.3 tree-sitter-languages==1.10.2 tantivy==0.22.0
          pip install -e . pytest pytest-asyncio pydantic-settings peewee watchdog psutil aiohttp uvicorn fastapi
          
      - name: Runtime Diagnostics
        run: |
          python -c "import tree_sitter; import tree_sitter_languages; import tantivy; print('âœ… All binary libs loaded')"
          pip list
          
      - name: Run core stability gates
        run: |
          export PYTHONPATH=$(pwd)/src
          pytest -v \
            tests/test_business_logic_smoke.py \
            tests/test_core_resilience_deep.py \
            tests/test_ast_intelligence.py