# 인덱싱/스캔 안정성 극대화 설계서

목표: **운영 안정성 극대화**를 위해 인덱싱 워커 분리와 스냅샷 DB 교체 방식을 도입한다.

---

## 1. 문제 정의

현재 구조는 단일 데몬에서 통신과 인덱싱을 동시에 처리한다. 이 구조는 다음 리스크를 가진다.
- MCP 응답 지연 스파이크
- 동시 인덱싱/검색 경합
- 부분 인덱스 노출 위험
- 장시간 실행 시 메모리/락 누적

---

## 2. 목표 구조

```
[Client stdio/http]
   └─ MCP 데몬 (FastMCP)
        ├─ 요청 처리/라우팅
        ├─ 읽기 전용 검색
        └─ 인덱싱 요청 큐

[Indexer Worker]
   └─ 인덱싱 전용 프로세스
        ├─ 파일 스캔
        ├─ 인덱스 생성 (스냅샷 DB)
        └─ 완료 시 원자적 교체
```

핵심 원칙:
- **MCP 데몬은 읽기만 담당**
- **인덱싱은 워커 단독 프로세스에서만 수행**
- **완성된 인덱스만 노출**

---

## 3. 구성 요소

### 3.1 MCP 데몬
- FastMCP 기반
- 검색 요청 처리
- 인덱싱 요청은 큐에 전달
- 워커 상태 확인/헬스체크

### 3.2 인덱싱 워커
- 별도 프로세스로 구동
- 워크스페이스 단위 직렬화
- 실패 시 기존 인덱스 유지

### 3.3 스냅샷 DB
- `index.db`를 직접 수정하지 않음
- 임시 파일에 완전 인덱싱 후 교체
- 교체는 원자적 rename

---

## 4. IPC/큐 설계

### 옵션 A: 파일 기반 큐 (단순/안정)
- `~/.local/share/sari/queue.jsonl`
- 데몬이 요청 기록, 워커가 소비
- 잠금은 `filelock`

### 옵션 B: 소켓 기반 큐 (고성능)
- 워커가 TCP/UDS로 대기
- 데몬이 요청 전달
- 장애 복구 복잡도 증가

**권장: 옵션 A (파일 기반 큐)**
- 안정성 우선
- 재시작/복구 용이

---

## 5. 락/중복 방지

- 워크스페이스 단위 락 파일
- 락 파일이 오래 점유되면 안전 해제
- 워커는 한 번에 하나의 워크스페이스만 처리

---

## 6. 스냅샷 교체 시나리오

1. 워커가 `index.db.tmp` 생성
2. 전체 인덱싱 완료
3. `index.db` → `index.db.bak` rename
4. `index.db.tmp` → `index.db` rename
5. 성공 후 `index.db.bak` 정리 (선택)

장점: 부분 인덱스 노출 없음

---

## 7. 장애 복구

- 워커 실패 시 기존 인덱스 유지
- `index.db.tmp`는 폐기
- 로그에 실패 사유 기록

---

## 8. 성능/안정성 지표

- MCP 응답 p95/p99 지연 감소
- 동시 요청 처리 안정화
- 인덱싱 실패율 감소
- 메모리 누수 없음

---

## 9. 단계별 구현

### 단계 1
- 워커 분리 구조 도입
- 파일 기반 큐

### 단계 2
- 스냅샷 DB 교체 적용

### 단계 3
- 모니터링/헬스체크 자동화

---

## 10. 리스크 및 대응

- 파일 큐 병목 → 배치 처리로 완화
- 워커 다운 → 자동 재시작
- 락 충돌 → TTL 기반 락 해제

---

## 11. 운영 정책

- 데몬은 항상 단일 인스턴스
- stdio는 프록시만 허용
- 인덱싱은 워커만 수행

