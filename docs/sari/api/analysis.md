# Sari 레포지토리 분석 보고서

## 1. 개요
**Sari**는 로컬 코드베이스를 효율적으로 검색하고 이해하기 위한 고성능 코드 검색 에이전트입니다. MCP(Model Context Protocol)를 구현하여 다양한 AI 어시스턴트(Claude, Cursor, Gemini 등)와 통합될 수 있습니다.

## 2. 주요 아키텍처
### 2.1 검색 엔진 (Search Engine)
- **하이브리드 검색:** Tantivy(Embedded 검색 엔진)와 SQLite FTS5를 결합하여 높은 성능과 호환성을 제공합니다.
- **다중 레이어 검색:**
  1. **L2 Cache:** 최근 작업한 파일 우선 검색.
  2. **Tantivy:** 주 검색 엔진으로 형태소 분석 기반의 고성능 검색 수행.
  3. **SQLite FTS5:** Tantivy를 사용할 수 없는 경우나 보조적인 폴백(Fallback)으로 사용.

### 2.2 인덱싱 파이프라인 (Indexing Pipeline)
- **스캔 및 감시:** `FileWatcher`와 `Scanner`를 통해 파일 변경을 실시간으로 감지하거나 전체 스캔을 수행합니다.
- **델타 인덱싱:** 파일의 `mtime`, `size` 및 `sha1` 해시를 비교하여 변경된 파일만 효율적으로 처리합니다.
- **파싱 전략:** 
  - **Tree-sitter (AST):** Python, JS, TS, Java 등 주요 언어에 대해 구문 트리 기반의 정밀한 심볼 추출을 수행합니다. (현재 Python이 가장 높은 정밀도 제공)
  - **Regex Fallback:** AST 파서가 없는 경우 정규표현식을 사용하여 클래스 및 함수 정보를 추출합니다.

### 2.3 MCP 도구 (MCP Tools)
- **검색(Search):** 코드 및 심볼 검색, API 엔드포인트 검색 지원.
- **탐색(Navigation):** 파일 목록, 파일 읽기, 심볼 읽기, 스니펫 관리.
- **코드 인텔리전스:** 콜 그래프(상/하위 호출 관계), 구현체 찾기, 컨텍스트 아카이빙.

## 3. 핵심 모듈 구조
- `sari/core/`: 검색, 인덱싱, DB 관리 등 핵심 엔진 로직.
- `sari/mcp/`: MCP 프로토콜 통신 및 도구 정의.
- `sari/core/parsers/`: 언어별 구문 분석 및 심볼 추출.
- `sari/core/engine/`: Tantivy 및 SQLite 검색 엔진 구현체.

## 4. 특징 및 장점
- **로컬 보안:** 모든 데이터와 인덱스가 사용자의 로컬 머신에만 저장됩니다.
- **토큰 최적화:** `PACK1`이라는 독자적인 텍스트 압축 형식을 사용하여 LLM과의 통신 시 토큰 소모를 최소화합니다.
- **확장성:** 플러그인 시스템을 통해 콜 그래프 분석 로직 등을 확장할 수 있습니다.

## 5. 향후 분석 제안
- `symbol_relations`가 구축되는 구체적인 AST 분석 로직(`ast_engine.py`) 심층 분석.
- `Tantivy` 엔진의 인덱스 스키마 및 랭킹 알고리즘 상세 확인.
- `PACK1` 형식의 효율성 벤치마크 분석.