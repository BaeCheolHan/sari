# Sari 설치/업데이트/실행 UX 정책 정리 (2026-02-05)

## 범위
- 다중 CLI + 다중 워크스페이스 실행
- 무중단 업데이트
- 종료(Shutdown) 정책

## 정책 요약 (목표)
1. **다중 CLI/다중 워크스페이스**
   - 한 머신에서 여러 CLI가 동시에 접속 가능
   - 한 데몬이 여러 워크스페이스를 동시에 처리 가능
   - 동일 워크스페이스에 대해서는 **중복 데몬 생성 금지** (재사용 우선)

2. **업데이트 무중단**
   - 기존 CLI 연결은 끊기지 않거나, 끊겨도 자동 재연결/재초기화
   - 새 데몬이 기동되면 구 데몬/HTTP 서버는 **graceful 종료**
   - 새로 실행한 CLI는 항상 최신 데몬으로 연결

3. **종료 정책**
   - 단일 CLI 종료로 데몬 전체를 내리면 안 됨
   - 워크스페이스 단위 refcount 기준으로 리소스 정리
   - 데몬 전체 종료는 **명시적 stop** 또는 **idle TTL** 기준

## 현재 구현 상태 (코드 기준)
### 1) 다중 워크스페이스
- `sari/mcp/session.py` + `sari/mcp/registry.py`
  - initialize의 `rootUri/rootPath`로 워크스페이스 결정을 함
  - 워크스페이스별 `SharedState`를 만들고 refcount로 관리
  - 같은 데몬에서 다중 워크스페이스 동시 처리 **가능**

### 2) 종료
- 워크스페이스 단위 refcount(클라이언트 연결 수) == 0 이면
  - indexer/DB/HTTP 종료 (`SharedState.shutdown`)
  - 데몬 프로세스 자체는 유지됨
- **데몬 자체 idle 종료 정책은 없음**

### 3) 업데이트/재연결
- 현재는 “새 데몬 -> 구 데몬 graceful 종료” 흐름이 없음
- 프록시/CLI가 끊겼을 때 자동 재연결 흐름이 부족함

## 갭/리스크
1. **포트 충돌 시 오동작**
   - 다른 MCP 데몬이 47779를 점유해도 "daemon running" 오판 가능
2. **동일 워크스페이스 중복 데몬**
   - global bootstrap이 매번 새 포트로 데몬을 띄우는 구조
   - 동일 DB를 여러 데몬이 붙을 위험
3. **무중단 업데이트 미완**
   - 구 데몬 종료/신규 데몬 승계 정책 부재
   - CLI 자동 재연결/재초기화 정책 부재
4. **종료 정책의 모호성**
   - 단일 CLI 종료 시 데몬 전체 종료는 하면 안 됨
   - 현재는 워크스페이스 리소스만 정리되고 데몬은 계속 유지됨

## 권장 변경사항 (정책 충족 방향)
### A. 데몬 재사용 정책
- 워크스페이스 기준으로 데몬 포트를 registry에 기록
- CLI/프록시는 시작 시 registry를 조회해 기존 데몬 우선 재사용
- 포트 충돌 시에도 **Sari 데몬인지 검증(identify 핸드셰이크)** 후 재사용

### B. 업데이트 무중단 정책
- 새 데몬이 기동되면 registry를 최신 포트로 업데이트
- 구 데몬은 일정 유예(예: 30초) 후 graceful 종료
- 프록시는 연결 끊김 시 registry 재조회 후 재연결 + initialize 재전송

### C. 종료 정책 (권장)
- 워크스페이스 단위:
  - refcount==0이면 해당 워크스페이스의 indexer/DB/HTTP만 종료
- 데몬 전체:
  - `sari daemon stop`은 명시적 종료
  - `SARI_DAEMON_IDLE_SEC` 기본 600초 같은 TTL 적용 가능
  - 모든 워크스페이스 refcount==0 + idle TTL 경과 시 종료

## 운영 규칙 (권장 UX)
- **기본값**: 데몬은 유지, 워크스페이스 리소스만 정리
- **명시 종료**: CLI 종료는 데몬 종료가 아님
- **자동 복구**: 연결 끊김 시 프록시 자동 재연결

